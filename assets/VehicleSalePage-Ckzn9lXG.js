import{r as m,j as e,a4 as G,t as K,x as N,a as l,f as R,k as I,u as T,b as A,c as B,d as H,a0 as U,e as b,i as Q,n as O,S as _}from"./index-C8Hi2I9-.js";import{z as L,w as F,B as z,G as Y,F as q,I as D}from"./schemas-ARZMo_di.js";import{P as J}from"./FieldArray-CybTVLLQ.js";import{P as W}from"./PageHeader-C3bsmlao.js";import{f as X}from"./formatInstallment-CrDG1pmT.js";import{d as Z,e as ee,i as te,u as se,b as ne}from"./index-Bn3msv5N.js";import{T as x}from"./ColorPreview-ffavdapq.js";import{S as o}from"./Section-BPNV-L4z.js";import{U as re,P as ae}from"./PaymentForm-7RTJENqF.js";import{u as oe,b as ie}from"./useButtonState-D8nv53KZ.js";import{S as ce}from"./Select-DaT4dAtZ.js";import{D as E}from"./Dialog-BSVWjxlV.js";import{C as ue}from"./CustomerFormInputs-D3VhTBVJ.js";import{a as le}from"./index-DAE3-cen.js";import{u as me}from"./DialogContext-DTkaQtxz.js";import{C as de,V as fe}from"./VehicleData-OBZFiZR2.js";import"./DataField-CDqrsgkO.js";import"./dialog-DBF6ydzz.js";const M=m.createContext(null);function he({children:s}){const[t,n]=m.useState(null);function i(u){n(u)}const c=m.useMemo(()=>({customer:t,handleCustomer:i}),[t]);return e.jsx(M.Provider,{value:c,children:s})}function pe({value:s,commissionValue:t}){return{customer:{id:""},payment:{commissionValue:t,saleDate:K({date:new Date,format:"yyyy-MM-dd"}),upfront:[],installment:{dueDate:"",value:s,status:G.PENDING,paymentDate:"",paymentMethod:""}}}}function V(){const s=m.useContext(M);if(!s)throw new Error("useVehicleSalePageContext must be used within a VehicleSalePageProvider");return s}function xe({commissionValue:s,minimumPrice:t}={}){return F({customer:F({id:L()}),payment:F({saleDate:Y(),commissionValue:z({min:0,max:s?Number(N(s)):0,formatter:n=>l(n,"money")??""}),upfront:ee,installment:Z})}).superRefine(te).superRefine(se).superRefine((n,i)=>{var a,f;const c=Number((a=n.payment.upfront[0])==null?void 0:a.value)||0,u=Number((f=n.payment.installment)==null?void 0:f.value)||0,r=Number(N(t??"0"))||0;c+u<r&&ne(i,"payment.installment.value","Valor menor que o preço mínimo")})}const Se=L().regex(/^[0-9.-]+$/).transform(s=>N(s));function je(s){const{vehicle:t}=s;return{...t,kilometers:l(t.kilometers,"number")??"",plateNumber:l(t.plateNumber,"plateNumber")??"",announcedPrice:l(t.announcedPrice,"money")??"",minimumPrice:l(t.minimumPrice,"money")??"",commissionValue:l(t.commissionValue,"money")??"",chassiNumber:l(t.chassiNumber,"chassi")??""}}function Ce({delay:s=300,initialValue:t=""}={}){const[n,i]=m.useState(t),[c,u]=m.useState(t);return m.useEffect(()=>{const r=setTimeout(()=>{u(n)},s);return()=>{clearTimeout(r)}},[n,s]),{setValue:i,value:c}}function ye({fetchCallback:s,name:t,label:n,queryKey:i,onChange:c,required:u,labelKey:r,valueKey:a,descriptionKey:f,select:C,onClickNotFound:h,formatSearch:y,formatNotFound:d}){const{value:j,setValue:g}=Ce(),{data:S,isLoading:k}=R({queryKey:[i,j],queryFn:({queryKey:p})=>s(p[1]),select:C}),w=m.useMemo(()=>S?S==null?void 0:S.map(p=>({label:String(p[r]),value:String(p[a]),description:String(p[f])})):[],[S,r,a,f]),P=m.useMemo(()=>{if(d)return d(j)},[j]);return e.jsx(ce,{name:t,onSearchChange:p=>{const v=y(p);v&&g(v)},label:n,options:w,shouldFilter:!1,loading:k,required:u,onChange:p=>{const v=S==null?void 0:S.find($=>String($[a])===p);c==null||c(v)},notFound:P&&h&&e.jsx(I,{label:`Cadastrar "${P}"`,variant:"quaternary",onClick:()=>h(P)})})}function ve(s){return{...s,cpf:l(s==null?void 0:s.cpf,"cpf")??"",phone:l(s==null?void 0:s.phone,"phone")??""}}function Ee({customerCpf:s,...t}){const{safeFetch:n}=T(),{showSuccessSnackbar:i}=A(),c=B(),{handleCustomer:u}=V(),{setValue:r}=oe();async function a(h){const{address:y,...d}=h,j=await n(`${b}/customer`,{method:"POST",body:d,resource:"CUSTOMERS",action:"CREATE"});return ve(j)}const{mutate:f,isPending:C}=H({mutationFn:a,onSuccess:h=>{i({title:"Cliente criado com sucesso"}),c.invalidateQueries({queryKey:["customers"]}),u(h),r("customer.id",String(h.id)),t.closeDialog()}});return e.jsxs(E,{...t,children:[e.jsx(E.Header,{title:"Novo cliente"}),e.jsx(E.Body,{children:e.jsxs(q,{defaultValues:{...U,cpf:s},schema:le,onSubmit:f,children:[e.jsx(ue,{}),e.jsx(E.Footer,{labelPrimaryBtn:"Criar",className:"px-0",dirty:!0,primaryBtnState:C?"loading":void 0,primaryBtnResource:"CUSTOMERS",primaryBtnAction:"CREATE"})]})})]})}function be(s){const t=[];for(const n of s)t.push({...n,cpf:l(n==null?void 0:n.cpf,"cpf")??"",phone:l(n==null?void 0:n.phone,"phone")??""});return t}function Ve(){const{safeFetch:s}=T(),t=me(),[n,i]=m.useState(""),{handleCustomer:c}=V();async function u(r){return r?(await s(`${b}/customer?cpf=${r}&orderBy=fullName`,{resource:"CUSTOMERS",action:"READ"})).data:[]}return e.jsxs(e.Fragment,{children:[e.jsx(Ee,{...t,customerCpf:n}),e.jsx(ye,{label:"CPF",name:"customer.id",fetchCallback:u,queryKey:"customers",onChange:r=>{if(!r){c(null);return}c(r)},labelKey:"fullName",valueKey:"id",descriptionKey:"cpf",required:!0,select:be,onClickNotFound:r=>{i(r),t.openDialog()},formatNotFound:r=>l(r,"cpf")??"",formatSearch:r=>{const a=Se.safeParse(r);if(a.success)return a.data}})]})}function ge(){return e.jsxs(e.Fragment,{children:[e.jsx(D,{label:"Data de venda",name:"payment.saleDate",type:"date",required:!0}),e.jsx(D,{label:"Valor da comissão",name:"payment.commissionValue",mask:"money"})]})}function Pe({vehicleData:s}){const[t,n]=m.useState("VEHICLE"),{errors:i}=ie(),{customer:c}=V();return e.jsxs(x,{children:[e.jsxs(x.Header,{children:[e.jsx(x.Tab,{isActive:t==="VEHICLE",title:"Veículo",onClick:()=>n("VEHICLE"),resource:"VEHICLE_SALE",action:"CREATE"}),e.jsx(x.Tab,{isActive:t==="CLIENT",title:"Cliente",onClick:()=>n("CLIENT"),hasError:!!(i!=null&&i.customer),resource:"VEHICLE_SALE",action:"CREATE"}),e.jsx(x.Tab,{isActive:t==="PAYMENT",title:"Pagamento",onClick:()=>n("PAYMENT"),hasError:!!(i!=null&&i.payment),resource:"VEHICLE_SALE",action:"CREATE"})]}),e.jsxs(x.Body,{children:[e.jsx(x.Section,{isActive:t==="CLIENT",children:e.jsxs(o,{children:[e.jsxs(o.Group,{children:[e.jsx(o.Header,{title:"Busque pelo cliente"}),e.jsx(o.Body,{children:e.jsx(Ve,{})})]}),e.jsxs(o.Group,{children:[e.jsx(o.Header,{title:"Dados do cliente"}),e.jsx(o.Body,{children:e.jsx(de,{customerData:c})})]})]})}),e.jsx(x.Section,{isActive:t==="VEHICLE",children:e.jsx(o,{children:e.jsxs(o.Group,{children:[e.jsx(o.Header,{title:"Dados do veículo"}),e.jsx(o.Body,{className:"grid-cols-3",children:e.jsx(fe,{vehicleData:s})})]})})}),e.jsx(x.Section,{isActive:t==="PAYMENT",children:e.jsxs(o,{children:[e.jsxs(o.Group,{children:[e.jsx(o.Header,{title:"Informações da venda"}),e.jsx(o.Body,{children:e.jsx(ge,{})})]}),e.jsxs(o.Group,{children:[e.jsx(o.Header,{title:"Informações da entrada"}),e.jsx(o.Body,{children:e.jsx(re,{})})]}),e.jsxs(o.Group,{children:[e.jsx(o.Header,{title:"Informações do pagamento"}),e.jsx(o.Body,{children:e.jsx(ae,{isAccountReceivable:!0})})]})]})})]})]})}function Fe(){const s=Q(),{safeFetch:t}=T(),{vehicleId:n}=O(),{showSuccessSnackbar:i}=A(),c=B(),{customer:u}=V();async function r(){return{payment:null,vehicle:await t(`${b}/vehicles/${n}`,{resource:"VEHICLES",action:"READ"})}}const{data:a,isFetching:f}=R({queryKey:["vehicle",n],queryFn:r,select:je});async function C({payment:d,customer:j}){const g=X({installment:d.installment,upfront:d.upfront});await t(`${b}/vehicles/sale`,{method:"POST",body:{vehicleId:n,customerId:j.id,date:d.saleDate,commissionValue:d.commissionValue,accountReceivable:{description:`Venda Veículo ${a==null?void 0:a.plateNumber}`,receivedFrom:(u==null?void 0:u.fullName)||""},installments:g},resource:"VEHICLE_SALE",action:"CREATE"})}const{mutate:h,isPending:y}=H({mutationFn:C,onSuccess:()=>{i({title:"Venda realizada com sucesso"}),s("/vehicles"),c.invalidateQueries({queryKey:["vehicles"]}),c.invalidateQueries({queryKey:["accounts-receivable"]}),c.invalidateQueries({queryKey:["accounts-payable"]})}});return f?e.jsx("div",{className:"flex justify-center items-center h-full w-full",children:e.jsx(_,{})}):a&&e.jsx("div",{className:"flex flex-col gap-4 w-full",children:e.jsxs(q,{onSubmit:h,className:"flex-1 flex flex-col gap-4",schema:xe({commissionValue:a.commissionValue,minimumPrice:a.minimumPrice}),defaultValues:pe({value:a.announcedPrice,commissionValue:a.commissionValue}),children:[e.jsx(W,{title:"Realizar venda"}),e.jsx(Pe,{vehicleData:a}),e.jsxs(J,{dirty:!0,primaryBtnState:y?"loading":void 0,children:[e.jsx(I,{color:"lightBlue",iconRight:"Save",label:"Salvar"}),e.jsx(I,{color:"red",iconRight:"Close",label:"Cancelar",onClick:()=>s("/vehicles")})]})]})})}function Oe(){return e.jsx(he,{children:e.jsx(Fe,{})})}export{Oe as default};
