import{r as l,j as e,u as V,g as B,d as A,f as P,a as U,b as G,c as O,L as $,e as K,n as _}from"./index-CwQymCQa.js";import{P as Q}from"./PageFooter-BC-TFmMj.js";import{P as Y}from"./PageHeader-ciO4E3wM.js";import{C as z,T as d}from"./ColorPicker-DjRP-oTN.js";import{I as T,b as j,u as J,F as D,o as p,s as x,n as W,t as X,c as Z,d as ee,v as te,m as se,a as re}from"./schemas-BL4SC9at.js";import{a as L,S as o}from"./Select-D2QyUKl8.js";import{s as ae}from"./selectStoresInfo-KV0O_9jG.js";import{C as R}from"./Choice-DMQtnXq8.js";import{D as E}from"./Dialog-D_sfX160.js";import{C as oe}from"./CustomerFormInputs-DmfSUFdW.js";import{a as ne}from"./index-GSyrbZxr.js";import{u as ce}from"./DialogContext-qdOZWBM2.js";import{D as g}from"./DataField-CyBI8K2e.js";import"./index-DTctZbkD.js";const M=l.createContext(null);function ie({children:t}){const[r,s]=l.useState(null);function c(i){s(i)}const n=l.useMemo(()=>({customer:r,handleCustomer:c}),[r]);return e.jsx(M.Provider,{value:n,children:t})}function le(){const{safeFetch:t}=V();async function r(){return await t(`${A}/store?orderBy=name`,{resource:"STORES",action:"READ"})}const{data:s,isFetching:c}=B({queryKey:["stores"],queryFn:r,select:ae}),n=l.useMemo(()=>s!=null&&s.data?s.data.map(i=>({label:String(i.name),value:String(i.id)})):[],[s]);return e.jsxs(e.Fragment,{children:[e.jsx(T,{label:"Modelo",name:"vehicle.model"}),e.jsx(T,{label:"Preço de venda",name:"vehicle.price",mask:"money"}),e.jsx(z,{name:"vehicle.color",label:"Cor do veículo",required:!0}),e.jsx(L,{label:"Loja",name:"vehicle.storeId",options:n,loading:c,required:!0})]})}function ue(){return e.jsxs(e.Fragment,{children:[e.jsx(R,{children:e.jsx(R.Checkbox,{name:"payment.isUpfront",label:"Possui entrada",value:!0})}),e.jsx(T,{label:"Parcelas",name:"payment.installments"})]})}function me({delay:t=300,initialValue:r=""}={}){const[s,c]=l.useState(r),[n,i]=l.useState(r);return l.useEffect(()=>{const a=setTimeout(()=>{i(s)},t);return()=>{clearTimeout(a)}},[s,t]),{setValue:c,value:n}}function de({fetchCallback:t,name:r,label:s,queryKey:c,onChange:n,required:i,labelKey:a,valueKey:u,descriptionKey:S,select:b,onClickNotFound:f,formatSearch:N,formatNotFound:F}){const{value:C,setValue:k}=me(),{data:h,isLoading:H}=B({queryKey:[c,C],queryFn:({queryKey:m})=>t(m[1]),select:b}),q=l.useMemo(()=>h?h==null?void 0:h.map(m=>({label:String(m[a]),value:String(m[u]),description:String(m[S])})):[],[h,a,u,S]),y=l.useMemo(()=>F(C),[C]);return e.jsx(L,{name:r,onSearchChange:m=>{const v=N(m);v&&k(v)},label:s,options:q,shouldFilter:!1,loading:H,required:i,onChange:m=>{const v=h==null?void 0:h.find(w=>String(w[u])===m);n==null||n(v)},notFound:y&&e.jsx(P,{label:`Cadastrar "${y}"`,variant:"quaternary",onClick:()=>f(y)})})}function I(){const t=l.useContext(M);if(!t)throw new Error("useVehicleSalePageContext must be used within a VehicleSalePageProvider");return t}function he(t){return{...t,cpf:j(t==null?void 0:t.cpf,"cpf")??"",phone:j(t==null?void 0:t.phone,"phone")??""}}function fe({customerCpf:t,...r}){const{safeFetch:s}=V(),{showSuccessSnackbar:c}=U(),n=G(),{handleCustomer:i}=I(),{setValue:a}=J();async function u(f){const{address:N,...F}=f,C=await s(`${A}/customer`,{method:"POST",body:F,resource:"CUSTOMERS",action:"CREATE"});return he(C)}const{mutate:S,isPending:b}=O({mutationFn:u,onSuccess:f=>{c({title:"Cliente criado com sucesso"}),n.invalidateQueries({queryKey:["customers"]}),i(f),a("customer.id",String(f.id)),r.closeDialog()}});return e.jsxs(E,{...r,children:[e.jsx(E.Header,{title:"Novo cliente"}),e.jsx(E.Body,{children:e.jsxs(D,{defaultValues:{...$,cpf:t},schema:ne,onSubmit:S,children:[e.jsx(oe,{}),e.jsx(E.Footer,{labelPrimaryBtn:"Criar",className:"px-0",dirty:!0,primaryBtnState:b?"loading":void 0,primaryBtnResource:"CUSTOMERS",primaryBtnAction:"CREATE"})]})})]})}function xe(t){const r=[];for(const s of t)r.push({...s,cpf:j(s==null?void 0:s.cpf,"cpf")??"",phone:j(s==null?void 0:s.phone,"phone")??""});return r}const je=p({customer:p({id:x()}),vehicle:p({storeId:x(),model:x(),price:se(),color:te(),commonCharacteristics:ee(["Direção hidráulica","Janelas elétricas","Ar condicionado","Travas elétricas","Câmera de ré","Air bag","Rodas de liga leve"]),characteristics:Z(p({label:x(),value:x()}),10)}),payment:p({isUpfront:X(),installments:W().positive()})}),Ce=x().regex(/^[0-9.-]+$/).transform(t=>t.replace(/\D/g,""));function pe(){const{safeFetch:t}=V(),r=ce(),[s,c]=l.useState(""),{handleCustomer:n}=I();async function i(a){return a?(await t(`${A}/customer?cpf=${a}&orderBy=fullName`,{resource:"CUSTOMERS",action:"READ"})).data:[]}return e.jsxs(e.Fragment,{children:[e.jsx(fe,{...r,customerCpf:s}),e.jsx(de,{label:"CPF",name:"customer.id",fetchCallback:i,queryKey:"customers",onChange:a=>{if(!a){n(null);return}n(a)},labelKey:"fullName",valueKey:"id",descriptionKey:"cpf",required:!0,select:xe,onClickNotFound:a=>{c(a),r.openDialog()},formatNotFound:a=>j(a,"cpf")??"",formatSearch:a=>{const u=Ce.safeParse(a);if(u.success)return u.data}})]})}function Se(){const{customer:t}=I();return e.jsxs(e.Fragment,{children:[e.jsx(g,{label:"Nome",value:t==null?void 0:t.fullName}),e.jsx(g,{label:"CPF",value:t==null?void 0:t.cpf}),e.jsx(g,{label:"Email",value:t==null?void 0:t.email}),e.jsx(g,{label:"Celular",value:t==null?void 0:t.phone})]})}function ve(){const[t,r]=l.useState("CLIENT"),{errors:s}=re();return e.jsxs(d,{children:[e.jsxs(d.Header,{children:[e.jsx(d.Tab,{isActive:t==="CLIENT",title:"Cliente",onClick:()=>r("CLIENT"),hasError:!!(s!=null&&s.customer),resource:"VEHICLE_SALE",action:"CREATE"}),e.jsx(d.Tab,{isActive:t==="VEHICLE",title:"Veículo",onClick:()=>r("VEHICLE"),hasError:!!(s!=null&&s.vehicle),resource:"VEHICLE_SALE",action:"CREATE"}),e.jsx(d.Tab,{isActive:t==="PAYMENT",title:"Pagamento",onClick:()=>r("PAYMENT"),hasError:!!(s!=null&&s.payment),resource:"VEHICLE_SALE",action:"CREATE"})]}),e.jsxs(d.Body,{children:[e.jsx(d.Section,{isActive:t==="CLIENT",children:e.jsxs(o,{children:[e.jsxs(o.Group,{children:[e.jsx(o.Header,{title:"Busque pelo cliente"}),e.jsx(o.Body,{children:e.jsx(pe,{})})]}),e.jsxs(o.Group,{children:[e.jsx(o.Header,{title:"Dados do cliente"}),e.jsx(o.Body,{children:e.jsx(Se,{})})]})]})}),e.jsx(d.Section,{isActive:t==="VEHICLE",children:e.jsxs(o,{children:[e.jsxs(o.Group,{children:[e.jsx(o.Header,{title:"Informações"}),e.jsx(o.Body,{children:e.jsx(le,{})})]}),e.jsxs(o.Group,{children:[e.jsx(o.Header,{title:"Selecione características comuns"}),e.jsx(o.Body,{})]}),e.jsxs(o.Group,{children:[e.jsx(o.Header,{title:"Adicione características"}),e.jsx(o.Body,{})]})]})}),e.jsx(d.Section,{isActive:t==="PAYMENT",children:e.jsx(o,{children:e.jsx(o.Group,{children:e.jsx(o.Body,{children:e.jsx(ue,{})})})})})]})]})}function Ee(){const t=K();return e.jsx("div",{className:"flex flex-col gap-4 w-full",children:e.jsxs(D,{onSubmit:r=>{const{commonCharacteristics:s,...c}=r.vehicle,n=s.map(a=>({label:a,value:"Sim"}));return{...r,vehicle:{...c,characteristics:[...r.vehicle.characteristics,...n]}}},className:"flex-1 flex flex-col gap-4",schema:je,defaultValues:{customer:{id:""},vehicle:{model:"Ford",price:j("10000","money"),color:"#FFFFFF",commonCharacteristics:[],characteristics:[]},payment:{isUpfront:!0,installments:1}},children:[e.jsx(Y,{title:"Realizar venda"}),e.jsx(ve,{}),e.jsxs(Q,{dirty:!0,children:[e.jsx(P,{color:"lightBlue",iconRight:"Save",label:"Salvar"}),e.jsx(P,{color:"red",iconRight:"Close",label:"Cancelar",onClick:()=>t(_)})]})]})})}function Me(){return e.jsx(ie,{children:e.jsx(Ee,{})})}export{Me as default};
