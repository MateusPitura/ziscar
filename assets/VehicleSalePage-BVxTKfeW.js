import{r as x,j as e,a3 as H,t as P,x as b,a as u,u as g,b as R,c as A,d as D,$ as L,e as C,i as w,o as k,f as q,S as K,l as F}from"./index-LO79eavt.js";import{x as V,B as $,G,w as T,F as M,N as U,I}from"./schemas-C0aL5P6j.js";import{P as Q}from"./FieldArray-nV10FFMi.js";import{P as O}from"./PageHeader-C8ixiw9T.js";import{f as _}from"./formatInstallment-wviza060.js";import{f as z}from"./formatVehicleCharacteristics-BEECkIz-.js";import{d as Y,e as J,i as W,u as X,b as Z}from"./index-DfarobFx.js";import{T as d}from"./ColorPreview-B_aHk8_N.js";import{S as o}from"./Section-dk9GDjtF.js";import{U as ee,P as te}from"./PaymentForm-B-c3y5pd.js";import{u as se,D as p,b as ae,c as ne}from"./useDialog-pT-Uqh-i.js";import{S as re}from"./Search-8ihBAnuu.js";import{C as oe}from"./CustomerFormInputs-B_g6LIiS.js";import{a as ie}from"./index-CEaMvw1z.js";import{C as ce,V as le}from"./VehicleData-DqNwy4xe.js";import"./Select-CrTaPVoa.js";import"./DataField-DvGceO3C.js";const B=x.createContext(null);function ue({children:t}){const[s,a]=x.useState(null);function r(l){a(l)}const c=x.useMemo(()=>({customer:s,handleCustomer:r}),[s]);return e.jsx(B.Provider,{value:c,children:t})}function me({value:t,commissionValue:s}){return{customer:{id:""},payment:{commissionValue:s,saleDate:P({date:new Date,format:"yyyy-MM-dd"}),upfront:[],installment:{dueDate:P({date:new Date,format:"yyyy-MM-dd"}),value:t,status:H.PENDING,paymentDate:"",paymentMethod:""}}}}function S(){const t=x.useContext(B);if(!t)throw new Error("useVehicleSalePageContext must be used within a VehicleSalePageProvider");return t}function de({commissionValue:t,minimumPrice:s}={}){return V({customer:V({id:T()}),payment:V({saleDate:G(),commissionValue:$({min:0,max:t?Number(b(t)):0,formatter:a=>u(a,"money")??""}),upfront:J,installment:Y})}).superRefine(W).superRefine(X).superRefine((a,r)=>{var m,i;const c=Number((m=a.payment.upfront[0])==null?void 0:m.value)||0,l=Number((i=a.payment.installment)==null?void 0:i.value)||0,n=Number(b(s??"0"))||0;c+l<n&&Z(r,"payment.installment.value","Valor menor que o preço mínimo")})}T().regex(/^[0-9.-]+$/).transform(t=>b(t));function fe(t){const{vehicle:s}=t;return{...s,kilometers:u(s.kilometers,"number")??"",plateNumber:u(s.plateNumber,"plateNumber")??"",announcedPrice:u(s.announcedPrice,"money")??"",minimumPrice:u(s.minimumPrice,"money")??"",commissionValue:u(s.commissionValue,"money")??"",chassiNumber:u(s.chassiNumber,"chassi")??""}}function he(t){return{...t,cpf:u(t==null?void 0:t.cpf,"cpf")??"",phone:u(t==null?void 0:t.phone,"phone")??""}}function xe({customerName:t,...s}){const{safeFetch:a}=g(),{showSuccessSnackbar:r}=R(),c=A(),{handleCustomer:l}=S(),{setValue:n}=se();async function m(h){const{address:N,...y}=h,f=await a(`${C}/customer`,{method:"POST",body:y,resource:"CUSTOMERS",action:"CREATE"});return he(f)}const{mutate:i,isPending:j}=D({mutationFn:m,onSuccess:h=>{r({title:"Cliente criado com sucesso"}),c.invalidateQueries({queryKey:["customers"]}),l(h),n("customer.id",String(h.id)),s.closeDialog()}});return e.jsxs(p,{...s,children:[e.jsx(p.Header,{title:"Novo cliente"}),e.jsx(p.Body,{children:e.jsxs(M,{defaultValues:{...L,fullName:t},schema:ie,onSubmit:i,children:[e.jsx(oe,{}),e.jsx(p.Footer,{labelPrimaryBtn:"Criar",className:"px-0",dirty:!0,primaryBtnState:j?"loading":void 0,primaryBtnResource:"CUSTOMERS",primaryBtnAction:"CREATE"})]})})]})}function pe(t){const s=[];for(const a of t)s.push({...a,cpf:u(a==null?void 0:a.cpf,"cpf")??"",phone:u(a==null?void 0:a.phone,"phone")??""});return s}function Ce(){const{safeFetch:t}=g(),s=ae(),[a,r]=x.useState(""),{handleCustomer:c}=S();async function l(n){return n?(await t(`${C}/customer?fullName=${n}&orderBy=fullName`,{resource:"CUSTOMERS",action:"READ"})).data:[]}return e.jsxs(e.Fragment,{children:[e.jsx(xe,{...s,customerName:a}),e.jsx(re,{label:"Nome",name:"customer.id",fetchCallback:l,queryKey:"customers",onChange:n=>{if(!n){c(null);return}c(n)},labelKey:"fullName",valueKey:"id",descriptionKey:"cpf",required:!0,select:pe,onClickNotFound:n=>{r(n),s.openDialog()},formatNotFound:n=>n==null?void 0:n.trim(),formatSearch:n=>{const m=U().safeParse(n);if(m.success)return m.data.trim()}})]})}function Se(){return e.jsxs(e.Fragment,{children:[e.jsx(I,{label:"Data de venda",name:"payment.saleDate",type:"date",required:!0}),e.jsx(I,{label:"Valor da comissão",name:"payment.commissionValue",mask:"money"})]})}function je({vehicleData:t}){const[s,a]=x.useState("VEHICLE"),{errors:r}=ne(),{customer:c}=S();return e.jsxs(d,{children:[e.jsxs(d.Header,{children:[e.jsx(d.Tab,{isActive:s==="VEHICLE",title:"Veículo",onClick:()=>a("VEHICLE"),resource:"VEHICLE_SALE",action:"CREATE"}),e.jsx(d.Tab,{isActive:s==="CLIENT",title:"Cliente",onClick:()=>a("CLIENT"),hasError:!!(r!=null&&r.customer),resource:"VEHICLE_SALE",action:"CREATE"}),e.jsx(d.Tab,{isActive:s==="PAYMENT",title:"Pagamento",onClick:()=>a("PAYMENT"),hasError:!!(r!=null&&r.payment),resource:"VEHICLE_SALE",action:"CREATE"})]}),e.jsxs(d.Body,{children:[e.jsx(d.Section,{isActive:s==="CLIENT",children:e.jsxs(o,{children:[e.jsxs(o.Group,{children:[e.jsx(o.Header,{title:"Busque pelo cliente"}),e.jsx(o.Body,{children:e.jsx(Ce,{})})]}),e.jsxs(o.Group,{children:[e.jsx(o.Header,{title:"Dados do cliente"}),e.jsx(o.Body,{children:e.jsx(ce,{customerData:c})})]})]})}),e.jsx(d.Section,{isActive:s==="VEHICLE",children:e.jsx(o,{children:e.jsxs(o.Group,{children:[e.jsx(o.Header,{title:"Dados do veículo"}),e.jsx(o.Body,{className:"grid-cols-3",children:e.jsx(le,{vehicleData:t})})]})})}),e.jsx(d.Section,{isActive:s==="PAYMENT",children:e.jsxs(o,{children:[e.jsxs(o.Group,{children:[e.jsx(o.Header,{title:"Informações da venda"}),e.jsx(o.Body,{children:e.jsx(Se,{})})]}),e.jsx(ee,{}),e.jsxs(o.Group,{children:[e.jsx(o.Header,{title:"Informações do pagamento"}),e.jsx(o.Body,{className:"grid-cols-3",children:e.jsx(te,{isAccountReceivable:!0})})]})]})})]})]})}function ye({contextHelper:t}){const s=w(),{safeFetch:a}=g(),{vehicleId:r}=k(),{showSuccessSnackbar:c}=R(),l=A(),{customer:n}=S();async function m(){const f=await a(`${C}/vehicles/${r}`,{resource:"VEHICLES",action:"READ"}),{vehicleCharacteristicValues:v,...E}=f;return{payment:null,vehicle:{...E,vehicleCharacteristicValues:z({vehicleCharacteristicValues:v})}}}const{data:i,isFetching:j}=q({queryKey:["vehicle",r],queryFn:m,select:fe});async function h({payment:f,customer:v}){const E=_({installment:f.installment,upfront:f.upfront});await a(`${C}/vehicles/sale`,{method:"POST",body:{vehicleId:r,customerId:v.id,date:f.saleDate,commissionValue:f.commissionValue,accountReceivable:{description:`Venda Veículo ${i==null?void 0:i.plateNumber}`,receivedFrom:(n==null?void 0:n.fullName)||""},installments:E},resource:"VEHICLE_SALE",action:"CREATE"})}const{mutate:N,isPending:y}=D({mutationFn:h,onSuccess:()=>{c({title:"Venda realizada com sucesso"}),s("/vehicles"),l.invalidateQueries({queryKey:["vehicles"]}),l.invalidateQueries({queryKey:["accounts-receivable"]}),l.invalidateQueries({queryKey:["accounts-payable"]})}});return j?e.jsx("div",{className:"flex justify-center items-center h-full w-full",children:e.jsx(K,{})}):i&&e.jsx("div",{className:"flex flex-col gap-4 w-full",children:e.jsxs(M,{onSubmit:N,className:"flex-1 flex flex-col gap-4",schema:de({commissionValue:i.commissionValue,minimumPrice:i.minimumPrice}),defaultValues:me({value:i.announcedPrice,commissionValue:i.commissionValue}),children:[e.jsx(O,{title:"Realizar venda",contextHelper:t}),e.jsx(je,{vehicleData:i}),e.jsxs(Q,{dirty:!0,primaryBtnState:y?"loading":void 0,children:[e.jsx(F,{color:"lightBlue",iconRight:"Save",label:"Salvar",tooltipMessage:"Salvar cadastro"}),e.jsx(F,{color:"red",iconRight:"Close",label:"Cancelar",onClick:()=>s("/vehicles"),tooltipMessage:"Cancelar cadastro"})]})]})})}function we({contextHelper:t}){return e.jsx(ue,{children:e.jsx(ye,{contextHelper:t})})}export{we as default};
