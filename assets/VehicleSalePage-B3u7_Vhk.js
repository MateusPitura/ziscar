import{r as x,j as e,a3 as B,w as N,y as E,a as u,u as v,b as F,c as I,d as R,$ as H,e as b,i as L,o as w,S as k,l as g}from"./index-CnY9f91V.js";import{x as y,B as q,G as K,w as T,F as A,N as G,I as P}from"./schemas-CZyi_FYc.js";import{P as U}from"./FieldArray-Ckm8lv6T.js";import{P as $}from"./PageHeader-nhaYMwqU.js";import{f as O}from"./formatInstallment-DC7w0kSr.js";import{u as Q}from"./useGetVehicleInfo-DNi_R4tO.js";import{d as _,e as z,i as Y,u as J,b as W}from"./index-8LNUc8ZP.js";import{T as m}from"./ColorPreview-COA3khnx.js";import{S as r}from"./Section-C_3Epz3l.js";import{U as X,P as Z}from"./PaymentForm-C1cv7kbc.js";import{u as ee,D as p,b as te,d as se}from"./useDialog-DgUnmKfd.js";import{S as ae}from"./Search-B-8kiSkH.js";import{C as ne}from"./CustomerFormInputs-VUbAqCvV.js";import{a as oe}from"./index-4KK65IIM.js";import{C as re,V as ie}from"./VehicleData-DJW-So1O.js";import"./formatVehicleCharacteristics-BEECkIz-.js";import"./Select-7V9bPDz1.js";import"./DataField-wmA4TIPk.js";const D=x.createContext(null);function ce({children:t}){const[s,a]=x.useState(null);function i(l){a(l)}const c=x.useMemo(()=>({customer:s,handleCustomer:i}),[s]);return e.jsx(D.Provider,{value:c,children:t})}function le({value:t,commissionValue:s}){return{customer:{id:""},payment:{commissionValue:s,saleDate:N({date:new Date,format:"yyyy-MM-dd"}),upfront:[],installment:{dueDate:N({date:new Date,format:"yyyy-MM-dd"}),value:t,status:B.PENDING,paymentDate:"",paymentMethod:""}}}}function j(){const t=x.useContext(D);if(!t)throw new Error("useVehicleSalePageContext must be used within a VehicleSalePageProvider");return t}function ue({commissionValue:t,minimumPrice:s}={}){return y({customer:y({id:T()}),payment:y({saleDate:K(),commissionValue:q({min:0,max:t?Number(E(t)):0,formatter:a=>u(a,"money")??""}),upfront:z,installment:_})}).superRefine(Y).superRefine(J).superRefine((a,i)=>{var o,d;const c=Number((o=a.payment.upfront[0])==null?void 0:o.value)||0,l=Number((d=a.payment.installment)==null?void 0:d.value)||0,n=Number(E(s??"0"))||0;c+l<n&&W(i,"payment.installment.value","Valor menor que o preço mínimo")})}T().regex(/^[0-9.-]+$/).transform(t=>E(t));function me(t){const{vehicle:s}=t;return{...s,kilometers:u(s.kilometers,"number")??"",plateNumber:u(s.plateNumber,"plateNumber")??"",announcedPrice:u(s.announcedPrice,"money")??"",minimumPrice:u(s.minimumPrice,"money")??"",commissionValue:u(s.commissionValue,"money")??"",chassiNumber:u(s.chassiNumber,"chassi")??""}}function de(t){return{...t,cpf:u(t==null?void 0:t.cpf,"cpf")??"",phone:u(t==null?void 0:t.phone,"phone")??""}}function fe({customerName:t,...s}){const{safeFetch:a}=v(),{showSuccessSnackbar:i}=F(),c=I(),{handleCustomer:l}=j(),{setValue:n}=ee();async function o(f){const{address:V,...h}=f,C=await a(`${b}/customer`,{method:"POST",body:h,resource:"CUSTOMERS",action:"CREATE"});return de(C)}const{mutate:d,isPending:S}=R({mutationFn:o,onSuccess:f=>{i({title:"Cliente criado com sucesso"}),c.invalidateQueries({queryKey:["customers"]}),l(f),n("customer.id",String(f.id)),s.closeDialog()}});return e.jsxs(p,{...s,children:[e.jsx(p.Header,{title:"Novo cliente"}),e.jsx(p.Body,{children:e.jsxs(A,{defaultValues:{...H,fullName:t},schema:oe,onSubmit:d,children:[e.jsx(ne,{}),e.jsx(p.Footer,{labelPrimaryBtn:"Criar",className:"px-0",dirty:!0,primaryBtnState:S?"loading":void 0,primaryBtnResource:"CUSTOMERS",primaryBtnAction:"CREATE"})]})})]})}function he(t){const s=[];for(const a of t)s.push({...a,cpf:u(a==null?void 0:a.cpf,"cpf")??"",phone:u(a==null?void 0:a.phone,"phone")??""});return s}function xe(){const{safeFetch:t}=v(),s=te(),[a,i]=x.useState(""),{handleCustomer:c}=j();async function l(n){return n?(await t(`${b}/customer?fullName=${n}&orderBy=fullName`,{resource:"CUSTOMERS",action:"READ"})).data:[]}return e.jsxs(e.Fragment,{children:[e.jsx(fe,{...s,customerName:a}),e.jsx(ae,{label:"Nome",name:"customer.id",fetchCallback:l,queryKey:"customers",onChange:n=>{if(!n){c(null);return}c(n)},labelKey:"fullName",valueKey:"id",descriptionKey:"cpf",required:!0,select:he,onClickNotFound:n=>{i(n),s.openDialog()},formatNotFound:n=>n==null?void 0:n.trim(),formatSearch:n=>{const o=G().safeParse(n);if(o.success)return o.data.trim()}})]})}function pe(){return e.jsxs(e.Fragment,{children:[e.jsx(P,{label:"Data de venda",name:"payment.saleDate",type:"date",required:!0}),e.jsx(P,{label:"Valor da comissão",name:"payment.commissionValue",mask:"money"})]})}function je({vehicleData:t}){const[s,a]=x.useState("VEHICLE"),{errors:i}=se(),{customer:c}=j();return e.jsxs(m,{children:[e.jsxs(m.Header,{children:[e.jsx(m.Tab,{isActive:s==="VEHICLE",title:"Veículo",onClick:()=>a("VEHICLE"),resource:"VEHICLE_SALE",action:"CREATE"}),e.jsx(m.Tab,{isActive:s==="CLIENT",title:"Cliente",onClick:()=>a("CLIENT"),hasError:!!(i!=null&&i.customer),resource:"VEHICLE_SALE",action:"CREATE"}),e.jsx(m.Tab,{isActive:s==="PAYMENT",title:"Pagamento",onClick:()=>a("PAYMENT"),hasError:!!(i!=null&&i.payment),resource:"VEHICLE_SALE",action:"CREATE"})]}),e.jsxs(m.Body,{children:[e.jsx(m.Section,{isActive:s==="CLIENT",children:e.jsxs(r,{children:[e.jsxs(r.Group,{children:[e.jsx(r.Header,{title:"Busque pelo cliente"}),e.jsx(r.Body,{children:e.jsx(xe,{})})]}),e.jsxs(r.Group,{children:[e.jsx(r.Header,{title:"Dados do cliente"}),e.jsx(r.Body,{children:e.jsx(re,{customerData:c})})]})]})}),e.jsx(m.Section,{isActive:s==="VEHICLE",children:e.jsx(r,{children:e.jsxs(r.Group,{children:[e.jsx(r.Header,{title:"Dados do veículo"}),e.jsx(r.Body,{className:"grid-cols-3",children:e.jsx(ie,{vehicleData:t})})]})})}),e.jsx(m.Section,{isActive:s==="PAYMENT",children:e.jsxs(r,{children:[e.jsxs(r.Group,{children:[e.jsx(r.Header,{title:"Informações da venda"}),e.jsx(r.Body,{children:e.jsx(pe,{})})]}),e.jsx(X,{}),e.jsxs(r.Group,{children:[e.jsx(r.Header,{title:"Informações do pagamento"}),e.jsx(r.Body,{className:"grid-cols-3",children:e.jsx(Z,{isAccountReceivable:!0})})]})]})})]})]})}function Se({contextHelper:t}){const s=L(),{safeFetch:a}=v(),{vehicleId:i}=w(),{showSuccessSnackbar:c}=F(),l=I(),{customer:n}=j(),{data:o,isFetching:d}=Q({select:me});async function S({payment:h,customer:C}){const M=O({installment:h.installment,upfront:h.upfront});await a(`${b}/vehicles/sale`,{method:"POST",body:{vehicleId:i,customerId:C.id,date:h.saleDate,commissionValue:h.commissionValue,accountReceivable:{description:`Venda Veículo ${o==null?void 0:o.plateNumber}`,receivedFrom:(n==null?void 0:n.fullName)||""},installments:M},resource:"VEHICLE_SALE",action:"CREATE"})}const{mutate:f,isPending:V}=R({mutationFn:S,onSuccess:()=>{c({title:"Venda realizada com sucesso"}),s("/vehicles"),l.invalidateQueries({queryKey:["vehicles"]}),l.invalidateQueries({queryKey:["accounts-receivable"]}),l.invalidateQueries({queryKey:["accounts-payable"]})}});return d?e.jsx("div",{className:"flex justify-center items-center h-full w-full",children:e.jsx(k,{})}):o&&e.jsx("div",{className:"flex flex-col gap-4 w-full",children:e.jsxs(A,{onSubmit:f,className:"flex-1 flex flex-col gap-4",schema:ue({commissionValue:o.commissionValue,minimumPrice:o.minimumPrice}),defaultValues:le({value:o.announcedPrice,commissionValue:o.commissionValue}),children:[e.jsx($,{title:"Realizar venda",contextHelper:t}),e.jsx(je,{vehicleData:o}),e.jsxs(U,{dirty:!0,primaryBtnState:V?"loading":void 0,children:[e.jsx(g,{color:"lightBlue",iconRight:"Save",label:"Salvar",tooltipMessage:"Salvar cadastro"}),e.jsx(g,{color:"red",iconRight:"Close",label:"Cancelar",onClick:()=>s("/vehicles"),tooltipMessage:"Cancelar cadastro"})]})]})})}function Le({contextHelper:t}){return e.jsx(ce,{children:e.jsx(Se,{contextHelper:t})})}export{Le as default};
