import{r as d,j as e,A as P,w as $,a4 as D,a as m,h as M,g as N,u as I,b as B,c as L,d as q,a0 as O,e as T,f as Q,l as _,S as z,F as Y,m as J,n as X}from"./index-CDuUmDit.js";import{z as H,w as g,B as W,G as Z,F as k,I as R}from"./schemas-CxmGnStq.js";import{S as ee,P as te}from"./FieldArray-Dw98_Trr.js";import{P as se}from"./PageHeader-B5SIBKuZ.js";import{d as ae,e as ne,i as re,u as oe,b as ie}from"./index-Bov_tmPN.js";import{T as x}from"./Tabs-CSWa71lB.js";import{S as o}from"./Section-Dx5LZFIe.js";import{U as ce,P as le}from"./PaymentForm-BT9tu9Xl.js";import{u as ue,b as me}from"./useButtonState-DJFFoANO.js";import{D as E}from"./Dialog-BW0_p7Tw.js";import{C as de}from"./CustomerFormInputs-CfLmp-SX.js";import{a as fe}from"./index-BmQgsMzq.js";import{u as he}from"./DialogContext-28MRl5PT.js";import{D as V}from"./DataField-B0EHyytN.js";import{V as pe}from"./VehicleData-D4gxu3_W.js";import"./dialog-3JPZnGOG.js";import"./ColorPreview-DSolxp2X.js";const w=d.createContext(null);function xe({children:t}){const[s,a]=d.useState(null);function i(u){a(u)}const l=d.useMemo(()=>({customer:s,handleCustomer:i}),[s]);return e.jsx(w.Provider,{value:l,children:t})}function je({value:t,commissionValue:s}){return{customer:{id:""},payment:{commissionValue:s,saleDate:$({date:new Date,format:"yyyy-MM-dd"}),upfront:[],installment:{dueDate:"",value:t,status:P.PENDING,paymentDate:"",paymentMethod:""}}}}function A(){const t=d.useContext(w);if(!t)throw new Error("useVehicleSalePageContext must be used within a VehicleSalePageProvider");return t}function Se({commissionValue:t,minimumPrice:s}={}){return g({customer:g({id:H()}),payment:g({saleDate:Z(),commissionValue:W({min:0,max:t?Number(D(t)):0,formatter:a=>m(a,"money")??""}),upfront:ne,installment:ae})}).superRefine(re).superRefine(oe).superRefine((a,i)=>{var f,j;const l=Number(a.payment.commissionValue)||0,u=Number((f=a.payment.upfront[0])==null?void 0:f.value)||0,n=Number((j=a.payment.installment)==null?void 0:j.value)||0,r=Number(D(s??"0"))||0;u+n<=r+l&&ie(i,"payment.installment.value","Valor menor que o preço mínimo mais a comissão")})}const ve=H().regex(/^[0-9.-]+$/).transform(t=>D(t));function Ce(t){const{vehicle:s}=t;return{...s,kilometers:m(s.kilometers,"number")??"",plateNumber:m(s.plateNumber,"plateNumber")??"",announcedPrice:m(s.announcedPrice,"money")??"",minimumPrice:m(s.minimumPrice,"money")??"",commissionValue:m(s.commissionValue,"money")??"",chassiNumber:m(s.chassiNumber,"chassi")??""}}function ye({delay:t=300,initialValue:s=""}={}){const[a,i]=d.useState(s),[l,u]=d.useState(s);return d.useEffect(()=>{const n=setTimeout(()=>{u(a)},t);return()=>{clearTimeout(n)}},[a,t]),{setValue:i,value:l}}function be({fetchCallback:t,name:s,label:a,queryKey:i,onChange:l,required:u,labelKey:n,valueKey:r,descriptionKey:f,select:j,onClickNotFound:h,formatSearch:C,formatNotFound:c}){const{value:v,setValue:y}=ye(),{data:S,isLoading:U}=M({queryKey:[i,v],queryFn:({queryKey:p})=>t(p[1]),select:j}),G=d.useMemo(()=>S?S==null?void 0:S.map(p=>({label:String(p[n]),value:String(p[r]),description:String(p[f])})):[],[S,n,r,f]),F=d.useMemo(()=>{if(c)return c(v)},[v]);return e.jsx(ee,{name:s,onSearchChange:p=>{const b=C(p);b&&y(b)},label:a,options:G,shouldFilter:!1,loading:U,required:u,onChange:p=>{const b=S==null?void 0:S.find(K=>String(K[r])===p);l==null||l(b)},notFound:F&&h&&e.jsx(N,{label:`Cadastrar "${F}"`,variant:"quaternary",onClick:()=>h(F)})})}function Ee(t){return{...t,cpf:m(t==null?void 0:t.cpf,"cpf")??"",phone:m(t==null?void 0:t.phone,"phone")??""}}function Ve({customerCpf:t,...s}){const{safeFetch:a}=I(),{showSuccessSnackbar:i}=B(),l=L(),{handleCustomer:u}=A(),{setValue:n}=ue();async function r(h){const{address:C,...c}=h,v=await a(`${T}/customer`,{method:"POST",body:c,resource:"CUSTOMERS",action:"CREATE"});return Ee(v)}const{mutate:f,isPending:j}=q({mutationFn:r,onSuccess:h=>{i({title:"Cliente criado com sucesso"}),l.invalidateQueries({queryKey:["customers"]}),u(h),n("customer.id",String(h.id)),s.closeDialog()}});return e.jsxs(E,{...s,children:[e.jsx(E.Header,{title:"Novo cliente"}),e.jsx(E.Body,{children:e.jsxs(k,{defaultValues:{...O,cpf:t},schema:fe,onSubmit:f,children:[e.jsx(de,{}),e.jsx(E.Footer,{labelPrimaryBtn:"Criar",className:"px-0",dirty:!0,primaryBtnState:j?"loading":void 0,primaryBtnResource:"CUSTOMERS",primaryBtnAction:"CREATE"})]})})]})}function Ae(t){const s=[];for(const a of t)s.push({...a,cpf:m(a==null?void 0:a.cpf,"cpf")??"",phone:m(a==null?void 0:a.phone,"phone")??""});return s}function Fe(){const{safeFetch:t}=I(),s=he(),[a,i]=d.useState(""),{handleCustomer:l}=A();async function u(n){return n?(await t(`${T}/customer?cpf=${n}&orderBy=fullName`,{resource:"CUSTOMERS",action:"READ"})).data:[]}return e.jsxs(e.Fragment,{children:[e.jsx(Ve,{...s,customerCpf:a}),e.jsx(be,{label:"CPF",name:"customer.id",fetchCallback:u,queryKey:"customers",onChange:n=>{if(!n){l(null);return}l(n)},labelKey:"fullName",valueKey:"id",descriptionKey:"cpf",required:!0,select:Ae,onClickNotFound:n=>{i(n),s.openDialog()},formatNotFound:n=>m(n,"cpf")??"",formatSearch:n=>{const r=ve.safeParse(n);if(r.success)return r.data}})]})}function ge(){const{customer:t}=A();return e.jsxs(e.Fragment,{children:[e.jsx(V,{label:"Nome",value:t==null?void 0:t.fullName}),e.jsx(V,{label:"CPF",value:t==null?void 0:t.cpf}),e.jsx(V,{label:"Email",value:t==null?void 0:t.email}),e.jsx(V,{label:"Celular",value:t==null?void 0:t.phone})]})}function Pe(){return e.jsxs(e.Fragment,{children:[e.jsx(R,{label:"Data de venda",name:"payment.saleDate",type:"date",required:!0}),e.jsx(R,{label:"Valor da comissão",name:"payment.commissionValue",mask:"money"})]})}function De({vehicleData:t}){const[s,a]=d.useState("VEHICLE"),{errors:i}=me();return e.jsxs(x,{children:[e.jsxs(x.Header,{children:[e.jsx(x.Tab,{isActive:s==="VEHICLE",title:"Veículo",onClick:()=>a("VEHICLE"),resource:"VEHICLE_SALE",action:"CREATE"}),e.jsx(x.Tab,{isActive:s==="CLIENT",title:"Cliente",onClick:()=>a("CLIENT"),hasError:!!(i!=null&&i.customer),resource:"VEHICLE_SALE",action:"CREATE"}),e.jsx(x.Tab,{isActive:s==="PAYMENT",title:"Pagamento",onClick:()=>a("PAYMENT"),hasError:!!(i!=null&&i.payment),resource:"VEHICLE_SALE",action:"CREATE"})]}),e.jsxs(x.Body,{children:[e.jsx(x.Section,{isActive:s==="CLIENT",children:e.jsxs(o,{children:[e.jsxs(o.Group,{children:[e.jsx(o.Header,{title:"Busque pelo cliente"}),e.jsx(o.Body,{children:e.jsx(Fe,{})})]}),e.jsxs(o.Group,{children:[e.jsx(o.Header,{title:"Dados do cliente"}),e.jsx(o.Body,{children:e.jsx(ge,{})})]})]})}),e.jsx(x.Section,{isActive:s==="VEHICLE",children:e.jsx(o,{children:e.jsxs(o.Group,{children:[e.jsx(o.Header,{title:"Dados do veículo"}),e.jsx(o.Body,{className:"grid-cols-3",children:e.jsx(pe,{vehicleData:t})})]})})}),e.jsx(x.Section,{isActive:s==="PAYMENT",children:e.jsxs(o,{children:[e.jsxs(o.Group,{children:[e.jsx(o.Header,{title:"Informações da venda"}),e.jsx(o.Body,{children:e.jsx(Pe,{})})]}),e.jsxs(o.Group,{children:[e.jsx(o.Header,{title:"Informações da entrada"}),e.jsx(o.Body,{children:e.jsx(ce,{})})]}),e.jsxs(o.Group,{children:[e.jsx(o.Header,{title:"Informações do pagamento"}),e.jsx(o.Body,{children:e.jsx(le,{isAccountReceivable:!0})})]})]})})]})]})}function Ne(){const t=Q(),{safeFetch:s}=I(),{vehicleId:a}=_(),{showSuccessSnackbar:i}=B(),l=L(),{customer:u}=A();async function n(){return{payment:{purchaseDate:"2023-01-01",paidTo:"Fulano de Tal",value:"7000000"},vehicle:{id:1,modelName:"Fusca",announcedPrice:8e6,plateNumber:"ABC1234",modelYear:1970,status:X.DELIVERED,archivedAt:void 0,brand:{id:10,name:"Volkswagen"},store:{id:1,name:"Loja 1"},category:J.CAR,color:"#FFFFFF",chassiNumber:"AAAAAAAAAAAAAAAAA",commissionValue:1e3,fuelType:Y.FLEX,kilometers:1e3,minimumPrice:8e6,yearOfManufacture:1970,characteristics:["Direção hidráulica","Janelas elétricas","Ar condicionado","Piloto automático","Vidros elétricos","Freios ABS"]}}}const{data:r,isFetching:f}=M({queryKey:["vehicle",a],queryFn:n,select:Ce});async function j({payment:c,customer:v}){const y=[{dueDate:c.installment.dueDate,value:c.installment.value,isUpfront:!1,paymentMethods:c.installment.status===P.PAID?[{type:c.installment.paymentMethod,value:c.installment.value,paymentDate:c.installment.paymentDate}]:null}];c.upfront.length&&y.push({dueDate:c.upfront[0].dueDate,value:c.upfront[0].value,isUpfront:!0,paymentMethods:c.upfront[0].status===P.PAID?[{type:c.upfront[0].paymentMethod,value:c.upfront[0].value,paymentDate:c.upfront[0].paymentDate}]:null}),await s(`${T}/vehicles/sale`,{method:"POST",body:{vehicleId:a,customerId:v.id,date:c.saleDate,commissionValue:c.commissionValue,accountReceivable:{description:`Venda Veículo ${r==null?void 0:r.plateNumber}`,receivedFrom:(u==null?void 0:u.fullName)||""},installments:y},resource:"VEHICLE_SALE",action:"CREATE"})}const{mutate:h,isPending:C}=q({mutationFn:j,onSuccess:()=>{i({title:"Venda realizada com sucesso"}),t("/vehicles"),l.invalidateQueries({queryKey:["vehicles"]}),l.invalidateQueries({queryKey:["accounts-receivable"]}),l.invalidateQueries({queryKey:["accounts-payable"]})}});return f?e.jsx("div",{className:"flex justify-center items-center h-full w-full",children:e.jsx(z,{})}):r&&e.jsx("div",{className:"flex flex-col gap-4 w-full",children:e.jsxs(k,{onSubmit:h,className:"flex-1 flex flex-col gap-4",schema:Se({commissionValue:r.commissionValue,minimumPrice:r.minimumPrice}),defaultValues:je({value:r.announcedPrice,commissionValue:r.commissionValue}),children:[e.jsx(se,{title:"Realizar venda"}),e.jsx(De,{vehicleData:r}),e.jsxs(te,{dirty:!0,primaryBtnState:C?"loading":void 0,children:[e.jsx(N,{color:"lightBlue",iconRight:"Save",label:"Salvar"}),e.jsx(N,{color:"red",iconRight:"Close",label:"Cancelar",onClick:()=>t("/vehicles")})]})]})})}function ze(){return e.jsx(xe,{children:e.jsx(Ne,{})})}export{ze as default};
