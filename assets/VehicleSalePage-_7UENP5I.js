import{r as x,j as e,a3 as H,a4 as N,y as v,a as u,u as y,b as F,c as I,d as R,$ as L,e as b,i as M,o as k,S as w,l as g}from"./index-BZf2WeKU.js";import{x as E,B as q,G as K,w as T,F as A,N as G,I as P}from"./schemas-uOsodSYq.js";import{P as U}from"./FieldArray-F9VSLlp9.js";import{P as $}from"./PageHeader-BhNPn7vC.js";import{f as O}from"./formatInstallment-Dx1IUn06.js";import{u as Q}from"./useGetVehicleInfo-MNFoQ4GZ.js";import{d as _,e as z,i as Y,u as J,b as W}from"./index-4_VLVWB1.js";import{T as m}from"./ColorPreview-541wF9q4.js";import{S as r}from"./Section-Bf1M-jgo.js";import{U as X,P as Z}from"./PaymentForm-DqmJa4eN.js";import{u as ee,D as p,b as se,d as te}from"./useDialog-Q2f17nT0.js";import{S as ae}from"./Search-DXN2sdgV.js";import{C as ne}from"./CustomerFormInputs-BEzoOIj5.js";import{a as oe}from"./index-xiYfcwLl.js";import{C as re,V as ie}from"./VehicleData-tYVhaQez.js";import"./formatVehicleCharacteristics-BEECkIz-.js";import"./Select-Brlr1v8A.js";import"./DataField-puxf29Nz.js";const D=x.createContext(null);function ce({children:s}){const[t,a]=x.useState(null);function i(l){a(l)}const c=x.useMemo(()=>({customer:t,handleCustomer:i}),[t]);return e.jsx(D.Provider,{value:c,children:s})}function le({value:s,commissionValue:t}){return{customer:{id:""},payment:{commissionValue:t,saleDate:N(),upfront:[],installment:{dueDate:N(),value:s,status:H.PENDING,paymentDate:"",paymentMethod:""}}}}function j(){const s=x.useContext(D);if(!s)throw new Error("useVehicleSalePageContext must be used within a VehicleSalePageProvider");return s}function ue({commissionValue:s,minimumPrice:t}={}){return E({customer:E({id:T()}),payment:E({saleDate:K(),commissionValue:q({min:0,max:s?Number(v(s)):0,formatter:a=>u(a,"money")??""}),upfront:z,installment:_})}).superRefine(Y).superRefine(J).superRefine((a,i)=>{var o,d;const c=Number((o=a.payment.upfront[0])==null?void 0:o.value)||0,l=Number((d=a.payment.installment)==null?void 0:d.value)||0,n=Number(v(t??"0"))||0;c+l<n&&W(i,"payment.installment.value","Valor menor que o preço mínimo")})}T().regex(/^[0-9.-]+$/).transform(s=>v(s));function me(s){const{vehicle:t}=s;return{...t,kilometers:u(t.kilometers,"number")??"",plateNumber:u(t.plateNumber,"plateNumber")??"",announcedPrice:u(t.announcedPrice,"money")??"",minimumPrice:u(t.minimumPrice,"money")??"",commissionValue:u(t.commissionValue,"money")??"",chassiNumber:u(t.chassiNumber,"chassi")??""}}function de(s){return{...s,cpf:u(s==null?void 0:s.cpf,"cpf")??"",phone:u(s==null?void 0:s.phone,"phone")??""}}function fe({customerName:s,...t}){const{safeFetch:a}=y(),{showSuccessSnackbar:i}=F(),c=I(),{handleCustomer:l}=j(),{setValue:n}=ee();async function o(f){const{address:V,...h}=f,C=await a(`${b}/customer`,{method:"POST",body:h,resource:"CUSTOMERS",action:"CREATE"});return de(C)}const{mutate:d,isPending:S}=R({mutationFn:o,onSuccess:f=>{i({title:"Cliente criado com sucesso"}),c.invalidateQueries({queryKey:["customers"]}),l(f),n("customer.id",String(f.id)),t.closeDialog()}});return e.jsxs(p,{...t,children:[e.jsx(p.Header,{title:"Novo cliente"}),e.jsx(p.Body,{children:e.jsxs(A,{defaultValues:{...L,fullName:s},schema:oe,onSubmit:d,children:[e.jsx(ne,{}),e.jsx(p.Footer,{labelPrimaryBtn:"Criar",className:"px-0",dirty:!0,primaryBtnState:S?"loading":void 0,primaryBtnResource:"CUSTOMERS",primaryBtnAction:"CREATE"})]})})]})}function he(s){const t=[];for(const a of s)t.push({...a,cpf:u(a==null?void 0:a.cpf,"cpf")??"",phone:u(a==null?void 0:a.phone,"phone")??""});return t}function xe(){const{safeFetch:s}=y(),t=se(),[a,i]=x.useState(""),{handleCustomer:c}=j();async function l(n){return n?(await s(`${b}/customer?fullName=${n}&orderBy=fullName`,{resource:"CUSTOMERS",action:"READ"})).data:[]}return e.jsxs(e.Fragment,{children:[e.jsx(fe,{...t,customerName:a}),e.jsx(ae,{label:"Nome",name:"customer.id",fetchCallback:l,queryKey:"customers",onChange:n=>{if(!n){c(null);return}c(n)},labelKey:"fullName",valueKey:"id",descriptionKey:"cpf",required:!0,select:he,onClickNotFound:n=>{i(n),t.openDialog()},formatNotFound:n=>n==null?void 0:n.trim(),formatSearch:n=>{const o=G().safeParse(n);if(o.success)return o.data.trim()}})]})}function pe(){return e.jsxs(e.Fragment,{children:[e.jsx(P,{label:"Data de venda",name:"payment.saleDate",type:"date",required:!0}),e.jsx(P,{label:"Valor da comissão",name:"payment.commissionValue",mask:"money"})]})}function je({vehicleData:s}){const[t,a]=x.useState("VEHICLE"),{errors:i}=te(),{customer:c}=j();return e.jsxs(m,{children:[e.jsxs(m.Header,{children:[e.jsx(m.Tab,{isActive:t==="VEHICLE",title:"Veículo",onClick:()=>a("VEHICLE"),resource:"VEHICLE_SALE",action:"CREATE"}),e.jsx(m.Tab,{isActive:t==="CLIENT",title:"Cliente",onClick:()=>a("CLIENT"),hasError:!!(i!=null&&i.customer),resource:"VEHICLE_SALE",action:"CREATE"}),e.jsx(m.Tab,{isActive:t==="PAYMENT",title:"Pagamento",onClick:()=>a("PAYMENT"),hasError:!!(i!=null&&i.payment),resource:"VEHICLE_SALE",action:"CREATE"})]}),e.jsxs(m.Body,{children:[e.jsx(m.Section,{isActive:t==="CLIENT",children:e.jsxs(r,{children:[e.jsxs(r.Group,{children:[e.jsx(r.Header,{title:"Busque pelo cliente"}),e.jsx(r.Body,{children:e.jsx(xe,{})})]}),e.jsxs(r.Group,{children:[e.jsx(r.Header,{title:"Dados do cliente"}),e.jsx(r.Body,{children:e.jsx(re,{customerData:c})})]})]})}),e.jsx(m.Section,{isActive:t==="VEHICLE",children:e.jsx(r,{children:e.jsxs(r.Group,{children:[e.jsx(r.Header,{title:"Dados do veículo"}),e.jsx(r.Body,{className:"grid-cols-3",children:e.jsx(ie,{vehicleData:s})})]})})}),e.jsx(m.Section,{isActive:t==="PAYMENT",children:e.jsxs(r,{children:[e.jsxs(r.Group,{children:[e.jsx(r.Header,{title:"Informações da venda"}),e.jsx(r.Body,{children:e.jsx(pe,{})})]}),e.jsx(X,{}),e.jsxs(r.Group,{children:[e.jsx(r.Header,{title:"Informações do pagamento"}),e.jsx(r.Body,{className:"grid-cols-3",children:e.jsx(Z,{isAccountReceivable:!0})})]})]})})]})]})}function Se({contextHelper:s}){const t=M(),{safeFetch:a}=y(),{vehicleId:i}=k(),{showSuccessSnackbar:c}=F(),l=I(),{customer:n}=j(),{data:o,isFetching:d}=Q({select:me});async function S({payment:h,customer:C}){const B=O({installment:h.installment,upfront:h.upfront});await a(`${b}/vehicles/sale`,{method:"POST",body:{vehicleId:i,customerId:C.id,date:h.saleDate,commissionValue:h.commissionValue,accountReceivable:{description:`Venda Veículo ${o==null?void 0:o.plateNumber}`,receivedFrom:(n==null?void 0:n.fullName)||""},installments:B},resource:"VEHICLE_SALE",action:"CREATE"})}const{mutate:f,isPending:V}=R({mutationFn:S,onSuccess:()=>{c({title:"Venda realizada com sucesso"}),t("/vehicles"),l.invalidateQueries({queryKey:["vehicles"]}),l.invalidateQueries({queryKey:["accounts-receivable"]}),l.invalidateQueries({queryKey:["accounts-payable"]})}});return d?e.jsx("div",{className:"flex justify-center items-center h-full w-full",children:e.jsx(w,{})}):o&&e.jsx("div",{className:"flex flex-col gap-4 w-full",children:e.jsxs(A,{onSubmit:f,className:"flex-1 flex flex-col gap-4",schema:ue({commissionValue:o.commissionValue,minimumPrice:o.minimumPrice}),defaultValues:le({value:o.announcedPrice,commissionValue:o.commissionValue}),children:[e.jsx($,{title:"Realizar venda",contextHelper:s}),e.jsx(je,{vehicleData:o}),e.jsxs(U,{dirty:!0,primaryBtnState:V?"loading":void 0,children:[e.jsx(g,{color:"lightBlue",iconRight:"Save",label:"Salvar",tooltipMessage:"Salvar cadastro"}),e.jsx(g,{color:"red",iconRight:"Close",label:"Cancelar",onClick:()=>t("/vehicles"),tooltipMessage:"Cancelar cadastro"})]})]})})}function Me({contextHelper:s}){return e.jsx(ce,{children:e.jsx(Se,{contextHelper:s})})}export{Me as default};
